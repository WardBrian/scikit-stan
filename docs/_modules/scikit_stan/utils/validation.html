
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>scikit_stan.utils.validation &#8212; SciKit Stan  documentation</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../../index.html">
  
  
  
  
  
    <p class="title logo__title">SciKit Stan  documentation</p>
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../getting-started.html">
  Getting Started
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../api.html">
  API Reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../../examples.html">
  Examples
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <span id="theme-switch" class="btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    
  </div>
</nav>
  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                
  <h1>Source code for scikit_stan.utils.validation</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">isclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">sp</span>
<span class="kn">from</span> <span class="nn">numpy.typing</span> <span class="kn">import</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">NDArray</span>

<span class="kn">from</span> <span class="nn">..exceptions</span> <span class="kn">import</span> <span class="n">NotFittedError</span>

<span class="sd">&quot;&quot;&quot; GENERAL LINK MAP</span>
<span class="sd">     identity - 0</span>
<span class="sd">     log - 1</span>
<span class="sd">     inverse - 2</span>
<span class="sd">     sqrt - 3</span>
<span class="sd">     inverse-square - 4</span>
<span class="sd">     logit - 5</span>
<span class="sd">     probit - 6</span>
<span class="sd">     cloglog - 7</span>
<span class="sd">     cauchit - 8</span>
<span class="sd">                    &quot;&quot;&quot;</span>

<span class="c1"># NOTE: linear model regression assumes constant variance,</span>

<span class="n">GAUSSIAN_LINKS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;identity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;inverse&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>


<span class="c1"># corresponding to logistic, normal and Cauchy CDFs respectively</span>
<span class="n">BINOMIAL_LINKS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;logit&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;probit&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&quot;cloglog&quot;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&quot;cauchit&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">}</span>

<span class="c1"># NOTE: the Gamma regression is on parameterized Gamma(mu, alpha)</span>
<span class="c1"># where alpha is considered fixed as linear models all assume constant variance</span>
<span class="n">GAMMA_LINKS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;identity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;inverse&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">POISSON_LINKS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;identity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;sqrt&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>


<span class="n">INVERSE_GAUSSIAN_LINKS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;identity&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;inverse&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;inverse-square&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">}</span>


<span class="n">FAMILY_LINKS_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span> <span class="n">GAUSSIAN_LINKS</span><span class="p">,</span>
    <span class="s2">&quot;binomial&quot;</span><span class="p">:</span> <span class="n">BINOMIAL_LINKS</span><span class="p">,</span>
    <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">GAMMA_LINKS</span><span class="p">,</span>
    <span class="s2">&quot;poisson&quot;</span><span class="p">:</span> <span class="n">POISSON_LINKS</span><span class="p">,</span>
    <span class="s2">&quot;inverse-gaussian&quot;</span><span class="p">:</span> <span class="n">INVERSE_GAUSSIAN_LINKS</span><span class="p">,</span>
    <span class="c1"># &quot;binomial&quot; : BINOMIAL_LINKS</span>
<span class="p">}</span>

<span class="n">SLOPE_PRIOR_DEFAULTS_INFO</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;normal&quot;</span><span class="p">:</span> <span class="s2">&quot;normal(0, 2.5 * sd(y) / sd(X)) if Gaussian else normal(0, 2.5)&quot;</span><span class="p">,</span>
    <span class="c1"># NOTE: the laplace distribution is translation invariant</span>
    <span class="s2">&quot;laplace&quot;</span><span class="p">:</span> <span class="s2">&quot;laplace(0, 2.5)&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">INTERCEPT_PRIOR_DEFAULTS_INFO</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;normal&quot;</span><span class="p">:</span> <span class="s2">&quot;normal(mu(y), 2.5 * sd(y)) if Gaussian else normal(0, 2.5)&quot;</span><span class="p">,</span>
    <span class="c1"># NOTE: the laplace distribution is translation invariant</span>
    <span class="s2">&quot;laplace&quot;</span><span class="p">:</span> <span class="s2">&quot;double_exponential(0, 2.5)&quot;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">PRIORS_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;normal&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># normal distribution, requires location (mu) and scale (sigma)</span>
    <span class="c1"># or else defaults to rstanarm&#39;s default:</span>
    <span class="c1"># https://cran.r-project.org/web/packages/rstanarm/vignettes/priors.html</span>
    <span class="s2">&quot;laplace&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># laplace distribution, requires location (mu) and scale (sigma)</span>
    <span class="c1"># or else defaults to double_exponential(0, 1)</span>
    <span class="c1"># for suggestions on this prior, refer to:</span>
    <span class="c1">#  https://www.jstor.org/stable/1403571#metadata_info_tab_contents</span>
<span class="p">}</span>

<span class="n">PRIORS_AUX_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;exponential&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># exponential distribution, requires only beta parameter</span>
    <span class="s2">&quot;chi2&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># chi-squared distribution, requires only nu parameter</span>
<span class="p">}</span>


<span class="c1"># NOTE: family and link combinations match R families package</span>
<span class="c1"># package: https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/family</span>
<div class="viewcode-block" id="validate_family"><a class="viewcode-back" href="../../../internal_api.html#scikit_stan.utils.validation.validate_family">[docs]</a><span class="k">def</span> <span class="nf">validate_family</span><span class="p">(</span><span class="n">family</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">link</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Validate family and link combination choice.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    family : str</span>
<span class="sd">        Name of chosen family. Only the following families are supported:</span>
<span class="sd">            &quot;gaussian&quot;, &quot;binomial&quot;, &quot;gamma&quot;, &quot;poisson&quot;, &quot;inverse-gaussian&quot;.</span>
<span class="sd">    link : Optional[str]</span>
<span class="sd">        Name of chosen link function. Only the following combinations are supported,</span>
<span class="sd">        following the R families package:</span>
<span class="sd">            * &quot;gaussian&quot;:</span>
<span class="sd">                * &quot;identity&quot; - Identity link function,</span>
<span class="sd">                * &quot;log&quot; - Log link function,</span>
<span class="sd">                * &quot;inverse&quot; - Inverse link function,</span>
<span class="sd">            * &quot;gamma&quot;:</span>
<span class="sd">                * &quot;identity&quot; - Identity link function,</span>
<span class="sd">                * &quot;log&quot; - Log link function,</span>
<span class="sd">                * &quot;inverse&quot; - Inverse link function,</span>
<span class="sd">            * &quot;inverse-gaussian&quot;:</span>
<span class="sd">                * &quot;identity&quot; - Identity link function,</span>
<span class="sd">                * &quot;log&quot; - Log link function,</span>
<span class="sd">                * &quot;inverse&quot; - Inverse link function,</span>
<span class="sd">                * &quot;inverse-square&quot; - Inverse square link function,</span>
<span class="sd">            * &quot;poisson&quot;:</span>
<span class="sd">                * &quot;identity&quot; - Identity link function,</span>
<span class="sd">                * &quot;log&quot; - Log link function,</span>
<span class="sd">                * &quot;sqrt&quot; - Square root link function,</span>
<span class="sd">            * &quot;binomial&quot;:</span>
<span class="sd">                * &quot;log&quot; - Log link function,</span>
<span class="sd">                * &quot;logit&quot; - Logit link function,</span>
<span class="sd">                * &quot;probit&quot; - Probit link function,</span>
<span class="sd">                * &quot;cloglog&quot; - Complementary log-log link function,</span>
<span class="sd">                * &quot;cauchit&quot; - Cauchit link function,</span>
<span class="sd">        If an invalid combination of family and link is passed, a ValueError is raised.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Passed family is not supported.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Passed link is not supported or is not valid for the chosen family.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">link</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Link function must be specified for family </span><span class="si">{</span><span class="n">family</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">family</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FAMILY_LINKS_MAP</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Family </span><span class="si">{</span><span class="n">family</span><span class="si">}</span><span class="s2"> not supported.</span>
<span class="s2">            Supported families: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">FAMILY_LINKS_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">link</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FAMILY_LINKS_MAP</span><span class="p">[</span><span class="n">family</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Link </span><span class="si">{</span><span class="n">link</span><span class="si">}</span><span class="s2"> not supported for family </span><span class="si">{</span><span class="n">family</span><span class="si">}</span><span class="s2">.</span>
<span class="s2">            These links are supported for </span><span class="si">{</span><span class="n">family</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">FAMILY_LINKS_MAP</span><span class="p">[</span><span class="n">family</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span>
        <span class="p">)</span></div>


<span class="c1"># adapted from sklearn&#39;s data validation scheme which is distributed under the 3-Clause BSD License.</span>
<div class="viewcode-block" id="check_array"><a class="viewcode-back" href="../../../internal_api.html#scikit_stan.utils.validation.check_array">[docs]</a><span class="k">def</span> <span class="nf">check_array</span><span class="p">(</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">ensure_2d</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_nd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Input validation on an array, list, sparse matrix or similar.</span>
<span class="sd">    By default, the input is checked to be a non-empty 2D array containing</span>
<span class="sd">    only finite values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : ArrayLike</span>
<span class="sd">        Array-like, list, sparse matrix, or similar of data to be checked.</span>
<span class="sd">    ensure_2d : bool, optional</span>
<span class="sd">        Whether to ensure that the array is 2D</span>
<span class="sd">    allow_nd : bool, optional</span>
<span class="sd">        Whether to allow the array to be an n-dimensional matrix where n &gt; 2</span>
<span class="sd">    dtype : type, optional</span>
<span class="sd">        Dtype of the data; regressions only supported on</span>
<span class="sd">        float64 or int64 arrays</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    NDArray[Union[np.float64, np.int64]]</span>
<span class="sd">        Verified set of data that can be used for regression.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Sparse, complex, or otherwise invalid data type passed for X.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Invalid number of dimensions in data passed for X, or otherwise data that</span>
<span class="sd">        cannot be recast to satisfy dimension requirements</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># NOTE: cmdstanpy automatically deals with Pandas dataframes</span>
    <span class="k">if</span> <span class="n">sp</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sd">&quot;&quot;&quot;Estimator does not currently support sparse data</span>
<span class="sd">             entry; consider extracting with .data.&quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">iscomplex</span><span class="p">(</span><span class="n">X</span><span class="p">)):</span>  <span class="c1"># type: ignore</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;Complex data not supported.&quot;&quot;&quot;</span><span class="p">)</span>

    <span class="n">array_res</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">array_res</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input contains NaN.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">array_res</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Input contains infinity or a value too large for this estimator.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">ensure_2d</span><span class="p">:</span>
        <span class="c1"># input cannot be scalar</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="n">array_res</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Singleton array or empty array cannot be considered a valid collection.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">array_res</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;0 feature(s) (shape=(</span><span class="si">{</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">, 0)) while a minimum of 1 &quot;</span>
                <span class="s2">&quot;is required.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">array_res</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;Expected 2D array, got scalar array instead:</span><span class="se">\n</span><span class="s2">array=</span><span class="si">{</span><span class="n">X</span><span class="si">!r}</span><span class="s2">.</span><span class="se">\n</span><span class="s2"></span>
<span class="s2">                    Reshape your data either using array.reshape(-1, 1) if</span>
<span class="s2">                    your data has a single feature or array.reshape(1, -1)</span>
<span class="s2">                    if it contains a single sample.&quot;&quot;&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">array_res</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sd">&quot;&quot;&quot;Passed data is one-dimensional, while estimator expects&quot;&quot;&quot;</span>
                <span class="o">+</span> <span class="s2">&quot;&quot;&quot; it to be at at least two-dimensional.&quot;&quot;&quot;</span>
            <span class="p">)</span>
            <span class="n">array_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">X</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_nd</span> <span class="ow">and</span> <span class="n">array_res</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Passed array with </span><span class="si">{</span><span class="n">array_res</span><span class="o">.</span><span class="n">ndim</span><span class="si">!r}</span><span class="s2"> dimensions. Estimator expected &lt;= 2.</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">array_res</span></div>


<span class="c1"># TODO: add additional arguments</span>
<span class="k">def</span> <span class="nf">_check_y</span><span class="p">(</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dtype</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]]:</span>
    <span class="k">return</span> <span class="n">check_array</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">ensure_2d</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>


<span class="c1"># adapted from sklearn&#39;s check_X_y validation scheme which</span>
<span class="c1"># is distributed under the 3-Clause BSD License.</span>
<span class="k">def</span> <span class="nf">check_X_y</span><span class="p">(</span>
    <span class="n">X</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span>
    <span class="n">ensure_X_2d</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">allow_nd</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">dtype</span><span class="p">:</span> <span class="nb">type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">]]]:</span>
    <span class="n">X_checked</span> <span class="o">=</span> <span class="n">check_array</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">ensure_2d</span><span class="o">=</span><span class="n">ensure_X_2d</span><span class="p">,</span> <span class="n">allow_nd</span><span class="o">=</span><span class="n">allow_nd</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">y_checked</span> <span class="o">=</span> <span class="n">_check_y</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">X_checked</span><span class="p">,</span> <span class="n">y_checked</span>


<span class="c1"># NOTE: This is derived from sk-learn&#39;s validation checks, which</span>
<span class="c1"># are distributed under the 3-Clause BSD License.</span>
<span class="c1"># TODO: simplify</span>
<div class="viewcode-block" id="check_is_fitted"><a class="viewcode-back" href="../../../internal_api.html#scikit_stan.utils.validation.check_is_fitted">[docs]</a><span class="k">def</span> <span class="nf">check_is_fitted</span><span class="p">(</span>
    <span class="n">estimator</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">attributes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">all_or_any</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">object</span><span class="p">]],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="nb">all</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Perform is_fitted validation for estimator.</span>
<span class="sd">    Checks if the estimator is fitted by verifying the presence of</span>
<span class="sd">    fitted attributes (ending with a trailing underscore) and otherwise</span>
<span class="sd">    raises a NotFittedError with the given message.</span>
<span class="sd">    If an estimator does not set any attributes with a trailing underscore, it</span>
<span class="sd">    can define a ``__sklearn_is_fitted__`` method returning a boolean to specify</span>
<span class="sd">    if the estimator is fitted or not.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    estimator : estimator instance</span>
<span class="sd">        estimator instance for which the check is performed.</span>
<span class="sd">    attributes : str, list or tuple of str, default=None</span>
<span class="sd">        Attribute name(s) given as string or a list/tuple of strings</span>
<span class="sd">        Eg.: ``[&quot;coef_&quot;, &quot;estimator_&quot;, ...], &quot;coef_&quot;``</span>
<span class="sd">        If `None`, `estimator` is considered fitted if there exist an</span>
<span class="sd">        attribute that ends with a underscore and does not start with double</span>
<span class="sd">        underscore.</span>
<span class="sd">    msg : str, default=None</span>
<span class="sd">        The default error message is, &quot;This %(name)s instance is not fitted</span>
<span class="sd">        yet. Call &#39;fit&#39; with appropriate arguments before using this</span>
<span class="sd">        estimator.&quot;</span>
<span class="sd">        For custom messages if &quot;%(name)s&quot; is present in the message string,</span>
<span class="sd">        it is substituted for the estimator name.</span>
<span class="sd">        Eg. : &quot;Estimator, %(name)s, must be fitted before sparsifying&quot;.</span>
<span class="sd">    all_or_any : callable, {all, any}, default=all</span>
<span class="sd">        Specify whether all or any of the given attributes must exist.</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NotFittedError</span>
<span class="sd">        If the attributes are not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">isclass</span><span class="p">(</span><span class="n">estimator</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is a class, not an instance.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">estimator</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;This </span><span class="si">%(name)s</span><span class="s2"> instance is not fitted yet. Call &#39;fit&#39; with &quot;</span>
            <span class="s2">&quot;appropriate arguments before using this estimator.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> is not an estimator instance.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">estimator</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">attributes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attributes</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">attributes</span><span class="p">]</span>
        <span class="n">fitted</span> <span class="o">=</span> <span class="n">all_or_any</span><span class="p">([</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attributes</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">estimator</span><span class="p">,</span> <span class="s2">&quot;is_fitted_&quot;</span><span class="p">):</span>
            <span class="n">fitted</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">is_fitted_</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> has no field is_fitted_, does not conform to required API&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">estimator</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">fitted</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotFittedError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">estimator</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">})</span></div>


<div class="viewcode-block" id="check_consistent_length"><a class="viewcode-back" href="../../../internal_api.html#scikit_stan.utils.validation.check_consistent_length">[docs]</a><span class="k">def</span> <span class="nf">check_consistent_length</span><span class="p">(</span><span class="o">*</span><span class="n">arrays</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Check that all arrays have consistent first dimensions.</span>
<span class="sd">    Checks whether all objects in arrays have the same shape or length.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *arrays : list or tuple of input objects.</span>
<span class="sd">        Objects that will be checked for consistent length.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">_num_samples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="k">for</span> <span class="n">X</span> <span class="ow">in</span> <span class="n">arrays</span> <span class="k">if</span> <span class="n">X</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">uniques</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uniques</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Found input variables with inconsistent numbers of samples: </span><span class="si">%r</span><span class="s2">&quot;</span>
            <span class="o">%</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">lgth</span><span class="p">)</span> <span class="k">for</span> <span class="n">lgth</span> <span class="ow">in</span> <span class="n">lengths</span><span class="p">]</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="_num_samples"><a class="viewcode-back" href="../../../internal_api.html#scikit_stan.utils.validation._num_samples">[docs]</a><span class="k">def</span> <span class="nf">_num_samples</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Return number of samples in array-like x.&quot;&quot;&quot;</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Expected sequence or array-like, got </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">fit</span><span class="p">):</span>
        <span class="c1"># Don&#39;t get num_samples from an ensembles length!</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;__array__&quot;</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;Singleton array </span><span class="si">%r</span><span class="s2"> cannot be considered a valid collection.&quot;</span> <span class="o">%</span> <span class="n">x</span>
            <span class="p">)</span>
        <span class="c1"># Check that shape is returning an integer or default to len</span>
        <span class="c1"># Dask dataframes may not return numeric shape[0] value</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Integral</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">type_error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">type_error</span></div>


<div class="viewcode-block" id="validate_prior"><a class="viewcode-back" href="../../../internal_api.html#scikit_stan.utils.validation.validate_prior">[docs]</a><span class="k">def</span> <span class="nf">validate_prior</span><span class="p">(</span><span class="n">prior_spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">coeff_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform validation on given prior dictionary for prior on either slope or intercept.</span>
<span class="sd">    This is only called when there is a prior to check.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    prior_spec : Dict[str, Any]</span>
<span class="sd">        Proposed prior dictionary, can be either for slope or intercept.</span>
<span class="sd">    coeff_type : str</span>
<span class="sd">        Specify whether the prior is for slope or intercept - should only be</span>
<span class="sd">        &#39;slope&#39; or &#39;intercept&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, Any]</span>
<span class="sd">        Validated dictionary of parameters for the given prior.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Validating a non-(slope or intercept) prior type.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Prior distribution is not specified.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Not all parameters for prior set-up are specified.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Prior sigma is negative.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">coeff_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;slope&quot;</span><span class="p">,</span> <span class="s2">&quot;intercept&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;coeff_type should be either &#39;slope&#39; or &#39;intercept&#39;, &quot;</span>
            <span class="s2">&quot;got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coeff_type</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="n">config_keys</span> <span class="o">=</span> <span class="n">prior_spec</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;prior_&quot;</span> <span class="o">+</span> <span class="n">coeff_type</span> <span class="o">+</span> <span class="s2">&quot;_dist&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_keys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;prior_</span><span class="si">{</span><span class="n">coeff_type</span><span class="si">}</span><span class="s2">_dist must be specified in prior given by </span><span class="si">{</span><span class="n">prior_spec</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="n">dist_key</span> <span class="o">=</span> <span class="n">prior_spec</span><span class="p">[</span><span class="s2">&quot;prior_&quot;</span> <span class="o">+</span> <span class="n">coeff_type</span> <span class="o">+</span> <span class="s2">&quot;_dist&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dist_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PRIORS_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Prior </span><span class="si">{</span><span class="n">dist_key</span><span class="si">}</span><span class="s2"> in prior specification </span><span class="si">{</span><span class="n">prior_spec</span><span class="si">}</span><span class="s2"> not supported.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;prior_&quot;</span> <span class="o">+</span> <span class="n">coeff_type</span> <span class="o">+</span> <span class="s2">&quot;_mu&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_keys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;prior_</span><span class="si">{</span><span class="n">coeff_type</span><span class="si">}</span><span class="s2">_mu must be specified in prior given by </span><span class="si">{</span><span class="n">prior_spec</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;prior_&quot;</span> <span class="o">+</span> <span class="n">coeff_type</span> <span class="o">+</span> <span class="s2">&quot;_sigma&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_keys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;prior_</span><span class="si">{</span><span class="n">coeff_type</span><span class="si">}</span><span class="s2">_sigma must be specified in prior given by </span><span class="si">{</span><span class="n">prior_spec</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="n">sigmas</span> <span class="o">=</span> <span class="n">prior_spec</span><span class="p">[</span><span class="s2">&quot;prior_&quot;</span> <span class="o">+</span> <span class="n">coeff_type</span> <span class="o">+</span> <span class="s2">&quot;_sigma&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">sigmas</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sigmas</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;prior_</span><span class="si">{</span><span class="n">coeff_type</span><span class="si">}</span><span class="s2">_sigma must be positive in prior given by </span><span class="si">{</span><span class="n">prior_spec</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">sigmas</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;prior_</span><span class="si">{</span><span class="n">coeff_type</span><span class="si">}</span><span class="s2">_sigma must be positive in prior given by </span><span class="si">{</span><span class="n">prior_spec</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;prior_&quot;</span> <span class="o">+</span> <span class="n">coeff_type</span> <span class="o">+</span> <span class="s2">&quot;_dist&quot;</span><span class="p">:</span> <span class="n">PRIORS_MAP</span><span class="p">[</span><span class="n">dist_key</span><span class="p">],</span>
        <span class="s2">&quot;prior_&quot;</span> <span class="o">+</span> <span class="n">coeff_type</span> <span class="o">+</span> <span class="s2">&quot;_mu&quot;</span><span class="p">:</span> <span class="n">prior_spec</span><span class="p">[</span><span class="s2">&quot;prior_&quot;</span> <span class="o">+</span> <span class="n">coeff_type</span> <span class="o">+</span> <span class="s2">&quot;_mu&quot;</span><span class="p">],</span>
        <span class="s2">&quot;prior_&quot;</span> <span class="o">+</span> <span class="n">coeff_type</span> <span class="o">+</span> <span class="s2">&quot;_sigma&quot;</span><span class="p">:</span> <span class="n">prior_spec</span><span class="p">[</span><span class="s2">&quot;prior_&quot;</span> <span class="o">+</span> <span class="n">coeff_type</span> <span class="o">+</span> <span class="s2">&quot;_sigma&quot;</span><span class="p">],</span>
    <span class="p">}</span></div>


<span class="c1"># TODO: to generalize to multi-parameter priors here, additional validation checks are</span>
<span class="c1"># necessary, and on the Stan side, priors to the log-likelihood should be set</span>
<span class="c1"># via a vector rather than just a single vague parameter.</span>
<div class="viewcode-block" id="validate_aux_prior"><a class="viewcode-back" href="../../../internal_api.html#scikit_stan.utils.validation.validate_aux_prior">[docs]</a><span class="k">def</span> <span class="nf">validate_aux_prior</span><span class="p">(</span><span class="n">aux_prior_spec</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Validates passed configuration for prior on auxiliary parameters.</span>
<span class="sd">    This does not perform parameter autoscaling.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    aux_prior_spec : Dict[str, Any]</span>
<span class="sd">        Dictionary containing configuration for prior on auxiliary parameters.</span>
<span class="sd">        Currently supported priors are: &quot;exponential&quot; and &quot;chi2&quot;, which are</span>
<span class="sd">        both parameterized by a single scalar.</span>
<span class="sd">        Priors here with more parameters are a future feature.</span>
<span class="sd">        For single-parameter priors, this field is a dictionary with the following keys</span>
<span class="sd">            &quot;prior_aux_dist&quot;: distribution of the prior on this parameter</span>
<span class="sd">            &quot;prior_aux_param&quot;: parameter of the prior on this parameter</span>

<span class="sd">        For example, to specify a chi2 prior with nu=2.5, pass</span>
<span class="sd">            {&quot;prior_aux_dist&quot;: &quot;chi2&quot;, &quot;prior_aux_param&quot;: 2.5}</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Dict[str, Any]</span>
<span class="sd">        Dictionary containing validated configuration for prior on auxiliary parameters.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Prior&#39;s distribution is not specified.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Unsupported prior distribution for auxiliary parameter.</span>
<span class="sd">    ValueError</span>
<span class="sd">        Prior distribution parameters are not specified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">config_keys</span> <span class="o">=</span> <span class="n">aux_prior_spec</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="k">if</span> <span class="s2">&quot;prior_aux_dist&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_keys</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;prior_aux_dist must be specified in auxiliary prior given by </span><span class="si">{</span><span class="n">aux_prior_spec</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="n">dist_key</span> <span class="o">=</span> <span class="n">aux_prior_spec</span><span class="p">[</span><span class="s2">&quot;prior_aux_dist&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">dist_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">PRIORS_AUX_MAP</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Prior </span><span class="si">{</span><span class="n">dist_key</span><span class="si">}</span><span class="s2"> in auxiliary prior specification </span><span class="si">{</span><span class="n">aux_prior_spec</span><span class="si">}</span><span class="s2"> not supported.&quot;</span>
        <span class="p">)</span>

    <span class="n">prior_aux_clean</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;prior_aux_dist&quot;</span><span class="p">:</span> <span class="n">PRIORS_AUX_MAP</span><span class="p">[</span><span class="n">dist_key</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># NOTE: this section has placeholder values, see the TODO above for generalization</span>
    <span class="c1"># add validation for additional priors on auxiliary variable(s) here</span>
    <span class="k">if</span> <span class="n">dist_key</span> <span class="o">==</span> <span class="s2">&quot;exponential&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;prior_aux_param&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;prior_aux_param must be specified in</span>
<span class="s2">                exponential auxiliary prior given by </span><span class="si">{</span><span class="n">aux_prior_spec</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="n">prior_aux_clean</span><span class="p">[</span><span class="s2">&quot;prior_aux_param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux_prior_spec</span><span class="p">[</span><span class="s2">&quot;prior_aux_param&quot;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">dist_key</span> <span class="o">==</span> <span class="s2">&quot;chi2&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;prior_aux_param&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;prior_aux_param must be specified in</span>
<span class="s2">                chi2 auxiliary prior given by </span><span class="si">{</span><span class="n">aux_prior_spec</span><span class="si">}</span><span class="s2">.&quot;&quot;&quot;</span>
            <span class="p">)</span>

        <span class="n">prior_aux_clean</span><span class="p">[</span><span class="s2">&quot;prior_aux_param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aux_prior_spec</span><span class="p">[</span><span class="s2">&quot;prior_aux_param&quot;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">prior_aux_clean</span></div>
</pre></div>

              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2022, Alexey Izmailov, Brian Ward.<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.0.2.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>